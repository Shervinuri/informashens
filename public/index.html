<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iNFORMA☬SHΞN™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- Base & Fonts --- */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #000000;
            color: #c9d1d9;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }
        main { flex-grow: 1; position: relative; z-index: 1; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .animated-gradient-text {
            background: linear-gradient(45deg, #ff4800, #ff8d00, #ffea00, #ff8d00, #ff4800);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient-wave 5s ease infinite;
        }
        @keyframes gradient-wave {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .gradient-black-gray {
            background: linear-gradient(to right, #a0a0a0, #444444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .shen-card {
            background-color: rgba(17, 17, 17, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 141, 0, 0.5);
            border-radius: 1.5rem;
            box-shadow: 0 0 20px rgba(255, 141, 0, 0.15);
            transition: all 0.3s ease;
        }
        .shen-input {
            width: 100%;
            background-color: #0a0a0a;
            border: 1px solid #444;
            border-radius: 0.75rem;
            padding: 1rem;
            font-size: 1.125rem;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            color: #c9d1d9;
            direction: rtl;
            text-align: right;
            font-family: 'Vazirmatn', sans-serif;
        }
        .shen-input:focus {
            border-color: #ff8d00;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 0 0 3px rgba(255, 141, 0, 0.4);
        }
        .shen-input::placeholder { color: #666; font-weight: 300; text-align: right; }
        textarea.shen-input { resize: none; }
        .mode-btn.active, .training-type-btn.active {
            background-color: #ff8d00;
            color: #000;
            font-weight: 700;
            box-shadow: 0 0 15px rgba(255, 141, 0, 0.5);
        }
        .mode-btn, .training-type-btn { border: 1px solid #444; }
        .chat-bubble { animation: slide-up 0.5s ease-out forwards; max-width: 95%; }
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .user-bubble { align-self: flex-end; }
        .ai-bubble { align-self: flex-start; }
        .shen-logo {
            width: 2.5rem; height: 2.5rem;
            background-color: rgba(255, 141, 0, 0.1);
            border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; font-weight: bold; color: #ff8d00;
            border: 1px solid rgba(255, 141, 0, 0.3);
            flex-shrink: 0;
        }
        #loading-indicator { min-height: 4rem; display: flex; align-items: center; justify-content: center; }
        #loading-indicator.hidden { display: none; }
        .loading-gradient-wave {
            font-family: monospace; white-space: nowrap;
            background: linear-gradient(90deg, #ff4800, #ff8d00, #ffea00, #ff8d00, #ff4800);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: loading-gradient-animation 2.5s infinite linear;
        }
        @keyframes loading-gradient-animation {
            0% { background-position: 150% 50%; }
            100% { background-position: -50% 50%; }
        }
        .code-block pre { user-select: text; -webkit-user-select: text; }
        #background-canvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; pointer-events: none; }
        .chat-container-fixed { flex-grow: 1; overflow-y: auto; max-height: calc(100vh - 200px); padding-bottom: 2rem; }
    </style>
</head>
<body class="pt-8 sm:pt-16" lang="fa">
    <canvas id="background-canvas"></canvas>
    <div class="flex flex-col min-h-screen">
        <main class="container mx-auto px-4 w-full flex-grow">
            <!-- Initial View -->
            <div id="initial-view" class="view max-w-3xl mx-auto">
                <div class="text-center mb-12">
                    <h1 class="text-3xl sm:text-4xl md:text-5xl font-black font-orbitron tracking-wide sm:tracking-wider">
                        <span class="gradient-black-gray">iNFORMA</span><span class="animated-gradient-text">SHΞN</span>
                    </h1>
                    <p class="text-sm md:text-base text-gray-300 mt-3">اولین لابراتوار دانشگاهی هسته مستقل شین</p>
                </div>
                <div class="shen-card p-6 md:p-8">
                    <div class="w-full bg-black/20 rounded-full p-1.5 flex flex-row items-center justify-between font-bold mb-8 shadow-inner">
                        <button data-mode="آموزش" class="mode-btn flex-1 py-2 rounded-full text-center transition-all duration-300 text-xs sm:text-sm md:text-base">یادم بده</button>
                        <button data-mode="تشریح مشکل" class="mode-btn flex-1 py-2 rounded-full text-center transition-all duration-300 text-xs sm:text-sm md:text-base active">مشکل خوردم</button>
                        <button data-mode="تحلیل ارور" class="mode-btn flex-1 py-2 rounded-full text-center transition-all duration-300 text-xs sm:text-sm md:text-base">خطای چیه ؟</button>
                    </div>
                    <div id="input-area" class="space-y-6"></div>
                    <div class="text-center mt-8">
                        <button id="start-btn" class="bg-gradient-to-br from-[#ff4800] to-[#ff8d00] text-black font-bold py-3 px-12 rounded-full text-lg hover:from-[#ff8d00] hover:to-[#ffea00] transition-all duration-300 transform hover:scale-105 shadow-lg shadow-orange-500/30">
                            بریـم بـراش
                        </button>
                    </div>
                </div>
            </div>
            <!-- Chat View -->
            <div id="chat-view" class="view hidden max-w-3xl mx-auto flex flex-col" style="min-height: 80vh;">
                <div id="menu-container" class="fixed top-5 right-5 z-20">
                    <button id="menu-toggle" class="w-12 h-12 rounded-full bg-gray-900/80 border border-orange-500/50 backdrop-blur-sm text-orange-400 flex items-center justify-center shadow-lg transform hover:scale-110 transition-all">
                        <i data-lucide="menu"></i>
                    </button>
                    <div id="floating-menu" class="absolute top-14 right-0 bg-black/80 border border-orange-500/50 backdrop-blur-md rounded-lg shadow-xl p-2 space-y-1 origin-top-right transition-all duration-200 transform scale-95 opacity-0 pointer-events-none">
                        <button id="home-btn" class="w-full flex items-center space-x-2 space-x-reverse p-2 rounded-md hover:bg-orange-500/10 transition-colors text-right text-orange-300">
                            <i data-lucide="home" class="w-5 h-5"></i>
                            <span>شروع مجدد</span>
                        </button>
                    </div>
                </div>
                <div class="text-center pt-4 pb-8">
                    <h2 class="text-xl font-bold" id="chat-title">تشریح مشکل</h2>
                    <p class="text-sm text-gray-400"> لابراتوار تحلیل متصل شد به ☬SHΞN™core</p>
                </div>
                <div id="chat-container" class="flex flex-col space-y-6 px-1 flex-grow overflow-y-auto" style="max-height: calc(100vh - 250px);"></div>
                 <!-- Input form for chat view -->
                <div id="chat-input-container" class="mt-auto pt-4">
                    <form id="chat-form" class="flex items-center gap-2">
                        <input id="chat-input" type="text" class="shen-input flex-grow" placeholder="پیام خود را بنویسید...">
                        <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white font-bold p-3 rounded-full transition-colors">
                            <i data-lucide="send"></i>
                        </button>
                    </form>
                </div>
            </div>
        </main>
        <footer class="py-6 text-center text-sm relative z-10">
            <p class="animated-gradient-text font-semibold">Exclusive ☬SHΞN™ made</p>
        </footer>
    </div>
    <!-- Templates -->
    <template id="template-آموزش"><div class="space-y-6"><input type="text" id="topic" class="shen-input" placeholder="محتوا مثال:طراحی بات تلگرامی"><div class="flex items-center bg-black/20 rounded-full p-2 space-x-2 space-x-reverse"><button data-value="شروع کلی" class="training-type-btn flex-1 p-3 rounded-md font-semibold text-xs sm:text-sm transition-colors active">آموزش کلی</button><button data-value="مقطعی" class="training-type-btn flex-1 p-3 rounded-md font-semibold text-xs sm:text-sm transition-colors">مبحث مشخص</button></div><div id="sub-topic-container" class="hidden"><input type="text" id="sub-topic" class="shen-input" placeholder=" کدوم بخش؟ مثلا: وبهوک "></div></div></template>
    <template id="template-تشریح-مشکل"><textarea id="problem-desc" class="shen-input h-48" placeholder="مشکل خود را به زبان ساده و با جزئیات کامل اینجا بنویسید..."></textarea></template>
    <template id="template-تحلیل-ارور"><div class="space-y-6"><input type="text" id="error-source" class="shen-input" placeholder=" محل خطا مثال: ترمینال لینوکس"><textarea id="error-text" class="shen-input h-48" placeholder="متن کامل ارور را اینجا کپی کنید..."></textarea></div></template>
    <template id="template-loading-indicator"><div class="ai-bubble flex items-center space-x-3 space-x-reverse self-start"><div class="shen-logo">☬</div><div class="p-4 rounded-2xl rounded-bl-lg bg-gray-800 border border-gray-700"><div class="loading-gradient-wave text-base font-semibold">[ ☬SHΞN™core thinking... ]</div></div></div></template>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const modeButtons = document.querySelectorAll('.mode-btn');
        const inputArea = document.getElementById('input-area');
        const startBtn = document.getElementById('start-btn');
        const initialView = document.getElementById('initial-view');
        const chatView = document.getElementById('chat-view');
        const chatContainer = document.getElementById('chat-container');
        const chatTitle = document.getElementById('chat-title');
        const menuToggle = document.getElementById('menu-toggle');
        const floatingMenu = document.getElementById('floating-menu');
        const homeBtn = document.getElementById('home-btn');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        let currentMode = 'تشریح مشکل';
        let chatHistory = [];
        const systemInstruction = `تو یک مربی IT حرفه‌ای به نام 'SHΞN™ learner' هستی. تمام پردازش‌ها در '☬SHΞN™core' انجام می‌شود. فقط به زبان فارسی روان صحبت کن، مگر برای اصطلاحات فنی. همیشه پاسخ‌ها را قدم به قدم و تعاملی بده. هرگز از ارائه پاسخ‌های طولانی یکجا خودداری کن. ⚠️ قانون اصلی: همیشه دقیقاً بر اساس اطلاعات کاربر پاسخ بده. هرگز چیزی را حدس نزن. هرگز نیاز نیست در ابتدای هر پیام سلام کنی. برای سوالات بله/خیر: از [YESNO:سوال] استفاده کن. برای گزینه‌ها: از [CHOICE:گزینه۱|گزینه۲|...] استفاده کن. برای دریافت متن: از [INPUT:توضیحات] استفاده کن. کدها را با \`\`\` مشخص کن.`;

        function initializeChat() {
            chatHistory = [{ role: "system", content: systemInstruction }];
        }
        function updateModeUI() {
            modeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === currentMode));
            const template = document.getElementById(`template-${currentMode.replace(/ /g, '-')}`);
            if (template) inputArea.innerHTML = template.innerHTML;
            chatTitle.textContent = currentMode;
        }
        function renderUserMessage(text) {
            const messageHtml = `<div class="user-bubble flex items-center self-end"><div class="p-4 rounded-2xl rounded-br-lg bg-orange-900/50 border border-orange-500/50"><p>${text.replace(/\n/g, '<br>')}</p></div></div>`;
            chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
        }
        function renderAiMessage(htmlContent) {
            const messageHtml = `<div class="ai-bubble flex items-start space-x-3 space-x-reverse self-start"><div class="shen-logo">☬</div><div class="p-4 rounded-2xl rounded-bl-lg bg-gray-800 border border-gray-700 w-full">${htmlContent}</div></div>`;
            chatContainer.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
        }
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        async function callApi(prompt) {
            const loadingTemplate = document.getElementById('template-loading-indicator').innerHTML;
            chatContainer.insertAdjacentHTML('beforeend', loadingTemplate);
            scrollToBottom();
            chatHistory.push({ role: "user", content: prompt });
            try {
                const response = await fetch('/api/ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: chatHistory }),
                });
                const loadingElement = chatContainer.querySelector('.ai-bubble:last-child');
                if (loadingElement) loadingElement.remove();
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'خطای ناشناخته از سرور');
                }
                const data = await response.json();
                const responseText = data.response;
                chatHistory.push({ role: "assistant", content: responseText });
                renderAiMessage(responseText);
            } catch (error) {
                console.error('API Call Error:', error);
                const loadingElement = chatContainer.querySelector('.ai-bubble:last-child');
                if (loadingElement) loadingElement.remove();
                renderAiMessage(`<p class="text-red-400">❌ خطای سیستمی: ${error.message}</p>`);
            }
        }
        async function handleStart() {
            let userPrompt = '';
            switch (currentMode) {
                case 'آموزش':
                    const topic = document.getElementById('topic').value;
                    if (!topic) { alert('لطفا موضوع آموزش را مشخص کنید.'); return; }
                    userPrompt = `موضوع: ${topic}.`;
                    break;
                case 'تشریح مشکل':
                    userPrompt = document.getElementById('problem-desc').value;
                    if (!userPrompt) { alert('لطفا مشکل خود را تشریح کنید.'); return; }
                    break;
                case 'تحلیل ارور':
                    const errorSource = document.getElementById('error-source').value;
                    const errorText = document.getElementById('error-text').value;
                    if (!errorText) { alert('لطفا متن کامل ارور را وارد کنید.'); return; }
                    userPrompt = `محل خطا: ${errorSource || 'نامشخص'}. \nمتن خطا:\n${errorText}`;
                    break;
            }
            initialView.classList.add('hidden');
            chatView.classList.remove('hidden');
            initializeChat();
            renderUserMessage(userPrompt);
            await callApi(userPrompt);
        }
        lucide.createIcons();
        updateModeUI();
        modeButtons.forEach(btn => btn.addEventListener('click', () => {
            currentMode = btn.dataset.mode;
            updateModeUI();
        }));
        startBtn.addEventListener('click', handleStart);
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = chatInput.value.trim();
            if (!prompt) return;
            renderUserMessage(prompt);
            chatInput.value = '';
            await callApi(prompt);
        });
        menuToggle?.addEventListener('click', (e) => {
            e.stopPropagation();
            floatingMenu.classList.toggle('scale-95');
            floatingMenu.classList.toggle('opacity-0');
            floatingMenu.classList.toggle('pointer-events-none');
        });
        homeBtn?.addEventListener('click', () => location.reload());
        document.addEventListener('click', (e) => {
            if (floatingMenu && !floatingMenu.classList.contains('opacity-0') && !menuToggle.contains(e.target)) {
                floatingMenu.classList.add('scale-95', 'opacity-0', 'pointer-events-none');
            }
        });
    });
    </script>
</body>
</html>
